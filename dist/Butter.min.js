!function(t,e){"function"==typeof define&&define.amd?define(["baconjs","jquery"],function(n,i){return t.Butter=e(n,i)}):"object"==typeof exports?module.exports=e(require("baconjs"),require("jquery")):t.Butter=e(Bacon,jQuery)}(this,function(t,e){var n,i,s,r,a,u,h,o;return n=o=function(n){var i=Object.prototype.toString,s=Object.keys,r=Array.prototype.indexOf,a=Array.prototype.forEach,u=function(t,e){var n,i,s=0;for(e=e.replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),n=e&&e.length;n-1>s;){if(i=e[s],!t[i])return;t=t[i],s++}return{pathArray:e,lastKey:e[e.length-1],value:t}},h={$:e,isBoolean:function(t){return"boolean"==typeof t},isObject:function(t){return"[object Object]"===i.call(t)&&!h.isUndefined(t)},isString:function(t){return"string"==typeof t},isArray:function(t){return"[object Array]"===i.call(t)},isFunction:function(t){return"function"==typeof t},isUndefined:function(t){return"undefined"==typeof t},isEqual:function(t,e){return JSON.stringify(t)===JSON.stringify(e)},isEmpty:function(t){return h.isObject?2===JSON.stringify(t).length:0===t.length},extend:function(t,e){for(var n in e)t[n]=e[n];return t},difference:function(t,e){var n=this,i=!1;return h.isEqual(t,e)||(i=t,h.isArray(t)?(i=[],h.each(t,function(t){n.contains(e,t)||i.push(t)})):h.isObject(t)&&(i={},h.each(t,function(t,n){e[t]||(i[t]=n)}))),i},clone:function(t){return h.isArray(t)||h.isObject(t)?JSON.parse(JSON.stringify(t)):t},contains:function(t,e){return!!~h.indexOf(t,e)},indexOf:function(e,n){var i=-1,s=0,a=e.length;if(h.isObject(n)){for(;a>s;s++)if(h.isEqual(e[s],n)){i=s;break}return i}return r?r.call(e,n):t._.indexOf(e,n)},each:function(t,n,i){var r=h.isObject(t);i=i||n.prototype,t&&(a&&s?r?a.call(s(t),function(e){n.apply(i,[e,t[e]])}):a.call(t,h.bind(n,i)):e.each(t,function(t,e){n.apply(i,r?[t,e]:[e,t])}))},bind:function(t,e){return function(){return t.apply(e,arguments)}},getObjectValueByPath:function(t,e){var n=u(t,e);if(n&&n.value)return n.value[n.lastKey]},setObjectValueByPath:function(t,e,n){var i=u(t,e);if(i&&i.value)return null!==n&&void 0!==n?(i.value[i.lastKey]=n,i.value):(i.value[i.lastKey]=null,delete i.value[i.lastKey],!0)}};return n=h}({}),i=function(t){return t={view:{binderSelector:"data-",destroyModelsCreated:!0,tagName:"div",id:null,className:null},data:{maxStatesLength:10,emulateHTTP:!0}}}({}),s=function(t){var e=n;return t={extend:function(t){return e.extend(this,t),this},exec:function(t){"function"==typeof this[t]&&this[t].apply(this,arguments)},removeProperties:function(){e.each(this,function(t,e){this[e]=null,delete this[e]},this)}}}({}),r=function(t){var e=n,i=function(t){e.each(t,function(t){t()})};return t={each:function(t,n,i){t.removeAttr(a.defaults.view.binderSelector+"each");var s=i.split(/\s+as\s+/gi),r=[],u=s[0],h=s[1],o=t.parent(),c=t.clone().removeAttr(a.defaults.view.binderSelector+"each");return t.remove(),{deferred:!0,addSubview:function(t,e){var i,s=c.clone();return i=new a.View({el:s,data:n,placeholderPath:h,bindingPath:u+"."+e}),r.push(i),i.bind(),i},get:function(){},set:function(){var t=[];e.each(n.get(u),function(){t.push(this.addSubview.apply(this,arguments).$el)},this),o.append(t),t=null,n.listen(u).debounce(50).onValue(e.bind(function(e){var n=r.length-e.length;if(n)if(n>0)for(;n--;)r[r.length-1].remove(),r.splice(r.length-1,1);else{for(t=[];n++<0;){var i=e.length+n-1;t.push(this.addSubview(e[i],i).$el)}o.append(t)}},this))},bind:function(){this.set(),this.get()},unbind:function(){e.each(r,function(t){t.remove()}),r=null,t.attr(a.defaults.view.binderSelector+"each",i),o.append(t)}}},show:function(t,e,n,i){var s;return{deferred:!0,get:function(){var r=function(e){e?t[i?"hide":"show"]():t[i?"show":"hide"]()};s=e.listen(n).debounce(50).onValue(r),r(e.get(n))},bind:function(){this.get()},unbind:function(){s()}}},hide:function(t,e,n){return this.show(t,e,n,!0)},css:function(t,n,s){var r=s.split(/\s+(?:&&|and)\s+/gi),a=[];return{set:function(){e.each(r,function(e){var i=e.split(/\s+as\s+/gi);a.push(n.listen(i[0]).startWith(n.get(i[0])).assign(t,"css",i[1]))})},bind:function(){this.set()},unbind:function(){i(a)}}},text:function(t,e,n){var i;return{set:function(){i=e.listen(n).debounce(50).startWith(e.get(n)).onValue(t,"text")},bind:function(){this.set()},unbind:function(){i()}}},value:function(t,e,n){var s=[],r=t.asEventStream("input change copy paste");return{get:function(){s.push(r.map(function(){return t.val()}).debounce(50).assign(e,"set",n))},set:function(){s.push(e.listen(n).startWith(e.get(n)).assign(t,"val"))},bind:function(){this.set(),this.get()},unbind:function(){i(s)}}}}}({}),u=function(r){var u=n,h=i,o=s,c=function(e){return this.__initialValues=e,this.__currentStateIndex=0,u.extend(this,o),u.extend(this,h.data),this.state=[],this.changes=new t.Bus,this.events=new t.Bus,this.isNew=!0,u.isUndefined(e)||this.set(e),this};return c.prototype={constructor:c,_changeToState:function(t,e){return this.state[t]&&(this.__currentStateIndex=t,this.update(this.state[t].attributes,e)),this},toString:function(){return JSON.stringify(this.toJSON())},toJSON:function(){return this.get()},get:function(t){var e,n=this.state[this.__currentStateIndex];return e=u.isUndefined(n)?void 0:u.isString(t)?u.getObjectValueByPath(n.attributes,t):u.isObject(n.attributes)||u.isArray(n.attributes)?n.attributes:n.attributes,u.clone(e)},parse:function(t){return t},validate:function(){return!0},changedAttributes:function(){return this.maxStatesLength>2&&this.__currentStateIndex?u.difference(this.state[this.__currentStateIndex-1].attributes,this.get()):this.get()},sync:function(t,n){var i,s,r;if(n=n||{},!this.url)throw new Error("This class instance doesn't have any url, it cannot be synched");switch(t){case"save":this.isNew?(t="create",i="POST"):(t="update",i=n.patch?"PATCH":"PUT");break;case"delete":i="DELETE";break;default:t="read",i="GET"}return"PATCH"===i?r=this.changedAttributes():"GET"!==i&&(r=this.get()),this.emulateHTTP&&r&&(r=u.extend({_method:i},r)),this.isNew=!1,s=e.ajax(u.extend({url:this.url,type:this.emulateHTTP?"GET"===i?"GET":"POST":i,data:"GET"===i?null:JSON.stringify(r),dataType:"json"},n)),s.always(u.bind(this.events.push,this,"sync")),s.then(u.bind(function(e){"GET"===i?this.update(e,"read"):this.events.push(t)},this),u.bind(this.events.error,this)),s},fetch:function(t){return this.sync("read",t)},save:function(t){return this.sync("save",t)},set:function(){var t=arguments,e=this.toJSON(),n=!1;return 2===t.length&&u.isString(t[0])&&t[1]?n=u.setObjectValueByPath(e,t[0],t[1]):(u.isObject(e)?u.extend(e,t[0]):e=t[0],n=!0),n&&this.update(e,"set"),this},unset:function(t){var e=this.get();return t?u.setObjectValueByPath(e,t,null):e=void 0,this.update(e,"unset"),this},reset:function(){return this.update(this.__initialValues,"reset"),this},add:function(t,e,n){var i=u.isString(e)?this.get(e):this.get();if(!u.isArray(i))throw new Error("You cannot push new data in an element that is not an array");return i.splice(n||i.length,0,t),e?this.set(e,i):this.update(i,"add"),this},remove:function(t,e){var n,i=u.isString(e)?this.get(e):this.get();if(!u.isArray(i))throw new Error("You cannot remove data from an element that is not an array");if(n=u.indexOf(i,t),!~n)throw new Error(JSON.stringify(t)+" was not found in this array");return i.splice(n,1),e?this.set(e,i):this.update(i,"remove"),this},update:function(t,e){var n=this.validate(t);return n!==!0?(this.events.error(n),!1):(t=this.parse(t),u.contains(["set","unset","reset","read","add","remove"],e)&&(this.state.push({method:e,attributes:t}),this.state.length>this.maxStatesLength+1&&this.state.shift(),this.__currentStateIndex=this.state.length-1,u.isArray(t)&&(this.length=t.length)),this.changes.push(t),this.events.push(e),this.attributes=t,this)},clone:function(){return new a.Data(this.get()).extend(this)},bind:function(t,e,n,i){var s=this,r=u.isUndefined(i)?!0:i;return r&&t.listen(n).onValue(function(t){s.set.apply(s,e?[e,t]:[t])}),this.listen(e).onValue(function(e){t.set.apply(t,n?[n,e]:[e])}),this},listen:function(t){var e,n;return t?(e=this.get(t),n=this.changes.map("."+t)):(e=this.get(),n=this.changes),n.startWith(e).skipWhile(function(t){return u.isEqual(t,e)}).skipDuplicates(u.isEqual)},on:function(t){return this.events.filter(function(e){return u.contains(t.split(" "),e)}).skipDuplicates()},undo:function(){return this.__currentStateIndex>0&&this._changeToState(--this.__currentStateIndex,"undo"),this},redo:function(){return this.__currentStateIndex<this.maxStatesLength&&this._changeToState(++this.__currentStateIndex,"redo"),this},destroy:function(t){var e=u.bind(function(){this.changes.end(),this.events.end(),this.removeProperties()},this);this.url&&!this.isNew?this.sync("delete",t).done(e):e()}},r=c}({}),h=function(u){var h=n,o=r,c=i,l=s,d=function(e){return this.options=e,this.destroyDataOnRemove=!1,this.events=[],this.callbacks=[],this.binders=[],this.views=[],h.extend(this,l),h.extend(this,c.view),h.extend(this,e||{}),this.state=new t.Bus,this.setData(this.data),this.setElement(this.el),this.state.onValue(h.bind(this.exec,this)),this};return d.prototype={constructor:d,setData:function(t){return this.options?(t&&t instanceof a.Data?this.data=t:(this.data=new a.Data(this.data),this.destroyDatasCreated&&(this.destroyDataOnRemove=!0)),this):this},setElement:function(t){var n={};return this.$el=t?t instanceof h.$?this.options.el:h.$(t):e("<"+this.tagName+">"),this.el=this.$el[0],this.className&&(n["class"]=this.className),this.id&&(n.id=this.id),this.$el.attr(n),this},$:function(t){return h.$(t,this.$el)},render:function(){return this.state.push("beforeRender"),this.template&&this.$el.html(h.isFunction(this.template)?this.template(this.data.get()):this.template),this.bind().state.push("afterRender"),this},unbind:function(){return this.$el.off(),h.each(this.events,function(t,e){this[e.name]&&(this[e.name].onValue()(),this[e.name]=null)},this),h.each(this.callbacks,function(t){t()}),h.each(this.binders,function(t){t()},this),this.binders=[],this},on:function(t){return this.state.filter(function(e){return h.contains(t.split(" "),e)}).skipDuplicates()},bindingPath:"",placeholderPath:"",bind:function(){var t=this,n=[];return this.unbind(),h.each(this.events,function(t){if(!t.name)throw new Error("You must specify an event name for each event assigned to this view");this[t.name]=this.$el.asEventStream(t.type,t.el),this.methods[t.name]&&h.isFunction(this.methods[t.name])&&this.callbacks.push(this[t.name].onValue(h.bind(this.methods[t.name],this)))},this),h.each(o,function(i){var s=this.binderSelector+i,r=function(r){var a,u=e(this),h=r||u.attr(s);if(t.placeholderPath&&t.bindingPath&&(h=h.replace(t.placeholderPath,t.bindingPath)),!h)throw new Error("The path to the data values is missing on the element "+this);h=h.replace(/[\n\r]+/g,"").replace(/^\s\s*/,"").replace(/\s\s*$/,""),a=o[i](u,t.data,h),a.deferred?n.push(a):a.bind(),t.binders.push(a.unbind)};this.$("["+s+"]").each(r);var a=this.$el.attr(s);a&&r.call(this.el,a)},this),h.each(n,function(t){t.bind()}),n=null,this},remove:function(){this.state.push("beforeRemove"),this.state.end(),this.unbind(),this.destroyDataOnRemove&&this.data.destroy(),this.$el&&this.$el.remove(),this.removeProperties()}},u=d}({}),a=function(t){return t={helpers:n,defaults:i,mixins:s,binders:r,Data:u,View:h,create:{View:function(t){return new a.View(t)},Data:function(t){return new a.Data(t)}}}}({})});