!function(t,e){"function"==typeof define&&define.amd?define(["baconjs","jquery"],e):"object"==typeof exports?module.exports=e(require("baconjs"),require("jquery")):t.Butter=e(Bacon,jQuery)}(this,function(t,e){var n,i,s,r,a,h,u,o;return n=o=function(n){var i=Object.prototype.toString,s=Object.keys,r=Array.prototype.indexOf,a=Array.prototype.forEach,h=function(t,e){var n,i,s=0;for(e=e.replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),n=e&&e.length;n-1>s;)i=e[s],t=t[i],s++;return{pathArray:e,lastKey:e[e.length-1],value:t}};return n={$:e,isBoolean:function(t){return"boolean"==typeof t},isObject:function(t){return"[object Object]"===i.call(t)},isString:function(t){return"string"==typeof t},isArray:function(t){return"[object Array]"===i.call(t)},isFunction:function(t){return"function"==typeof t},isUndefined:function(t){return"undefined"==typeof t},extend:function(t,e){for(var n in e)t[n]=e[n];return this.clone(t)},isEmpty:function(t){return this.isObject?2===JSON.stringify(t).length:0===t.length},difference:function(t,e){var n=this,i=!1;return this.isEqual(t,e)||(i=t,this.isArray(t)?(i=[],console.log(t),this.each(t,function(t){n.contains(e,t)||i.push(t)})):this.isObject(t)&&(i={},this.each(t,function(t,n){e[t]||(i[t]=n)}))),i},clone:function(t){return t?JSON.parse(JSON.stringify(t)):{}},contains:function(t,e){return!!~this.indexOf(t,e)},indexOf:function(e,n){var i=-1,s=0,a=e.length;if(this.isObject(n)){for(;a>s;s++)if(this.isEqual(e[s],n)){i=e[s];break}return i}return r?r.call(e,n):t._.indexOf(e,n)},each:function(t,n,i){var r=this.isObject(t);return i=i?this.bind(n,i):n.prototype,a&&s?r?void a.call(s(t),function(e){n.apply(i,[e,t[e]])}):a.apply(t,i):e.each(t,function(t,e){n.apply(i,r?[t,e]:[e,t])})},bind:function(t,e){return function(){return t.apply(e,arguments)}},isEqual:function(t,e){return JSON.stringify(t)===JSON.stringify(e)},getObjectValueByPath:function(t,e){var n=h(t,e);return n.value[n.lastKey]},setObjectValueByPath:function(t,e,n){var i=h(t,e);return null!==n&&void 0!==n?(i.value[i.lastKey]=n,i.value):(i.value[i.lastKey]=null,delete i.value[i.lastKey],!0)}}}({}),i=function(t){return t={view:{binderSelector:"data-",destroyModelsCreated:!0},data:{maxStatesLength:10,emulateHTTP:!0}}}({}),s=function(t){var e=n;return t={extend:function(t){return e.extend(this,t)},exec:function(t){"function"==typeof this[t]&&this[t].apply(this,arguments)},removeProperties:function(){e.each(this,function(t,e){this[e]=null,delete this[e]},this)}}}({}),r=function(t){return t={text:function(t,e,n){return{set:function(){e.listen(n).onValue(t,"text")}}},val:function(t){return{events:function(){t.asEventStream("change")},get:function(){return t.val()},set:function(e){t.val(e)}}}}}({}),a=function(r){var a=n,h=i,o=s;return r=function(n){var i=0,s=null;return this._constructor=function(){return a.extend(this,o),a.extend(this,h.data),this.state=[],this.changes=new t.Bus,this.events=new t.Bus,this.isNew=!0,(a.isObject(n)||a.isArray(n))&&(this.set(n),s=this.get()),this},this._changeToState=function(t,e){return this.state[t]&&(i=t,this.update(this.state[t].attributes,e)),this},this.toString=function(){return JSON.stringify(this.get())},this.get=function(t){var e=this.state[i];return e?a.isString(t)?a.getObjectValueByPath(e.attributes,t):a.clone(e.attributes):n||{}},this.parse=function(t){return t},this.validate=function(){return!0},this.changedAttributes=function(){return this.maxStatesLength>2&&i?a.difference(this.state[i-1].attributes,this.get()):this.get()},this.sync=function(t,n){var i,s,r;if(n=n||{},!this.url)throw new Error("This class instance doesn't have any url, it cannot be synched");switch(t){case"save":this.isNew?(t="create",i="POST"):(t="update",i=n.patch?"PATCH":"PUT");break;case"delete":i="DELETE";break;default:t="read",i="GET"}return"PATCH"===i?r=this.changedAttributes():"GET"!==i&&(r=this.get()),this.emulateHTTP&&r&&(r=a.extend({_method:i},r)),this.isNew=!1,s=e.ajax(a.extend({url:this.url,type:this.emulateHTTP?"GET"===i?"GET":"POST":i,data:"GET"===i?null:JSON.stringify(r),dataType:"json"},n)),s.then(a.bind(function(e){"GET"===i?this.update(e,"read"):this.events.push(t)},this),a.bind(this.events.error,this),a.bind(this.events.push,this,"sync")),s},this.fetch=function(t){return this.sync("read",t)},this.save=function(t){return this.sync("save",t)},this.set=function(){var t=this.get(),e=!1;return a.isString(arguments[0])?e=a.setObjectValueByPath(t,arguments[0],arguments[1]):(a.isObject(t)?a.extend(t,arguments[0]):t=arguments[0],e=!0),e&&this.update(t,"set"),this},this.unset=function(t){var e=this.get();return t&&a.setObjectValueByPath(e,t,null)&&this.update(e,"unset"),this},this.reset=function(){return this.update(s,"reset"),this},this.add=function(t,e,n){var i=a.isString(e)?this.get(e):this.get();if(!a.isArray(i))throw console.log(i),new Error("You cannot push new data in an element that is not an array");return i.splice(n||i.length,0,t),e?this.set(e,i):this.update(i,"add"),this},this.remove=function(t,e){var n,i=a.isString(e)?this.get(e):this.get();if(!a.isArray(i))throw new Error("You cannot remove data from an element that is not an array");if(n=a.indexOf(t,i),!~n)throw new Error(JSON.stringify(t)+" was not found in this array");return i=i.splice(n,1),e?this.set(e,i):this.update(i,"remove"),this},this.update=function(t,e){var n=this.validate(t);return n!==!0?(this.events.error(n),!1):(t=this.parse(t),this.changes.push(t),a.contains(["set","unset","reset","read","add","remove"],e)&&(this.state.push({method:e,attributes:t}),this.state.length>this.maxStatesLength+1&&this.state.shift(),i=this.state.length-1,a.isArray(t)&&(this.length=t.length)),this.events.push(e),this)},this.clone=function(){return new u.Data(this.get()).extend(this)},this.bind=function(t,e,n,i){var s=a.isUndefined(i)?!0:i,r=function(e){n?t.set(n,e):t.set(e)};return e?this.listen(e).onValue(r):this.changes.skipDuplicates(a.isEqual).onValue(r),s&&t.bind(this,n,e,!1),this},this.listen=function(t){return this.changes.map("."+t).skipDuplicates(a.isEqual)},this.on=function(t){return this.events.filter(function(e){return a.contains(t.split(" "),e)}).skipDuplicates()},this.undo=function(){return i>0&&this._changeToState(--i,"undo"),this},this.redo=function(){return i<this.maxStatesLength&&this._changeToState(++i,"redo"),this},this.destroy=function(t){var e=a.bind(function(){this.changes.end(),this.events.end(),this.removeProperties()},this);this.url&&!this.isNew?this.sync("delete",t).done(e):e()},this._constructor()}}({}),h=function(e){var r=n,a=i,h=s;return e=function(e){return this._constructor=function(){return r.extend(this,h),r.extend(this,a.view),this.bindings=[],this.views=[],this.template=e.template,this.destroyDataOnRemove=!1,this.state=new t.Bus,r.each(e,function(t,e){"function"==typeof e?this[t]=e:"data"===t&&(e instanceof u.Data?this[t]=e:(this[t]=new u.Data(e),this.destroyDatasCreated&&(this.destroyDataOnRemove=!0)))},this),e.el&&this.setElement(e.el),this.state.onValue(r.bind(this.exec,this)),this},this.setElement=function(t){return this.$el=t instanceof r.$?e.el:r.$(t),this.el=this.$el[0],this.el||console.warn(e.el+"was not found!"),this},this.$=function(t){return r.$(t,this.$el)},this.render=function(){return this.state.push("beforeRender"),this.template&&this.$el.html(this.template),this.bind().state.push("afterRender"),this},this.unbind=function(){return this.$el.off(),r.each(e.events,function(t,e){this[e.name]&&(this[e.name].onValue()(),this[e.name]=null)},this),this},this.bind=function(){return this.unbind(),r.each(e.events,function(t){this[t.name]=this.$el.asEventStream(t.type,t.el)},this),this},this.parse=function(){},this.remove=function(){this.state.push("beforeRemove"),this.state.end(),this.destroyDataOnRemove&&this.model.destroy(),this.$el.remove(),this.removeProperties()},this._constructor()}}({}),u=function(t){return t={helpers:n,defaults:i,mixins:s,binders:r,Data:a,View:h}}({})});