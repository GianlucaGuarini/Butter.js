(function(e,t){typeof define=="function"&&define.amd?define(["baconjs","jquery"],function(n,r){return e.Butter=t(n,r)}):typeof exports=="object"?module.exports=t(require("baconjs"),require("jquery")):e.Butter=t(Bacon,jQuery)})(this,function(e,t){var n,r,i,s,o,u,a,f;return n=f=function(n){var r=Object.prototype.toString,i=Object.keys,s=Array.prototype.indexOf,o=Array.prototype.forEach,u=function(e,t){var n,r=0,i;t=t.replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),n=t&&t.length;while(r<n-1){i=t[r];if(!e[i])return;e=e[i],r++}return{pathArray:t,lastKey:t[t.length-1],value:e}},a={$:t,isBoolean:function(e){return typeof e=="boolean"},isObject:function(e){return r.call(e)==="[object Object]"&&!a.isUndefined(e)&&e!==null},isString:function(e){return typeof e=="string"},isArray:function(e){return r.call(e)==="[object Array]"},isRegExp:function(e){return r.call(e)==="[object RegExp]"},isFunction:function(e){return r.call(e)==="[object Function]"},isUndefined:function(e){return typeof e=="undefined"},isEqual:function(e,t){return JSON.stringify(e)===JSON.stringify(t)},isEmpty:function(e){return a.isObject(e)?JSON.stringify(e).length===2:e.length===0},extend:function(e,t){for(var n in t)e[n]=t[n];return e},difference:function(e,t,n){var r=this,i=!1;return a.isEqual(e,t)||(i=e,a.isArray(e)?(i=[],a.each(e,function(e){r.contains(t,e)||i.push(e)})):a.isObject(e)&&(i={},a.each(e,function(e,n){t[e]||(i[e]=n)}))),i},clone:function(e){return a.isArray(e)||a.isObject(e)?JSON.parse(JSON.stringify(e)):e},contains:function(e,t){return!!~a.indexOf(e,t)},indexOf:function(t,n){var r=-1,i=0,o=t.length;if(a.isObject(n)){for(;i<o;i++)if(a.isEqual(t[i],n)){r=i;break}return r}return s?s.call(t,n):e._.indexOf(t,n)},each:function(e,n,r){var s=this,u=this.isObject(e);r=r||n.prototype;if(!e)return;o&&i?u?o.call(i(e),function(t){n.apply(r,[t,e[t]])}):o.call(e,this.bind(n,r)):t.each(e,function(e,t){n.apply(r,u?[e,t]:[t,e])})},keys:i||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},bind:function(e,t){return function(){return e.apply(t,arguments)}},getObjectValueByPath:function(e,t){var n=u(e,t);if(!n||!n.value)return;return n.value[n.lastKey]},setObjectValueByPath:function(e,t,n){var r=u(e,t);if(!r||!r.value)return;return n===null?(r.value[r.lastKey]=null,delete r.value[r.lastKey],!0):(r.value[r.lastKey]=n,r.value)}};return n=a,n}({}),r=function(e){return e={view:{binderSelector:"data-",destroyDatasCreated:!0,tagName:"div",id:null,className:null,fetchTemplate:function(e){return t(e).html()},insert:function(e){this.$el.append(e)}},data:{maxStatesLength:10,emulateHTTP:!0},router:{}},e}({}),i=function(e){var t=n;return e={extend:function(e){return t.extend(this,e),this},exec:function(e){typeof this[e]=="function"&&this[e].apply(this,arguments)},removeProperties:function(){var e=this;t.each(this,function(t,n){e[n]=null,delete e[n]})}},e}({}),s=function(e){var r=n,i=function(e){r.each(e,function(e){e()})},s=function(){return t('<script type="text/bacon-marker"></script>')};return e={each:function(e,t,n){e.removeAttr(o.defaults.view.binderSelector+"each");var i=n.split(/\s+as\s+/gi),s=[],u=i[0],a=i[1],f=e.parent(),l=function(e,n){var r=c.clone(),i;return i=new o.View({el:r,data:t,placeholderPath:a,bindingPath:u+"."+n}),s.push(i),i.bind(),i},c=e.clone().removeAttr(o.defaults.view.binderSelector+"each");return e.remove(),{deferred:!0,set:function(){var e=[],n=function(t){var n=s.length-t.length;if(!n)return;if(n>0)while(n--)s[s.length-1].remove(),s.splice(s.length-1,1);else{e=[];while(n++<0){var r=t.length+n-1;e.push(l(t[r],r).$el)}f.append(e)}};r.each(t.get(u),function(){e.push(l.apply(this,arguments).$el)}),f.append(e),e=null,t.listen(u).onValue(n)},bind:function(){this.set()},unbind:function(){r.each(s,function(e){e.remove()}),s=null,e.attr(o.defaults.view.binderSelector+"each",n),f.append(e)}}},"if":function(e,t,n,r){var i,o=!1,u=s(),a=function(){o||(o=!0,e.replaceWith(u))},f=function(){o&&(o=!1,u.replaceWith(e))};return{deferred:!0,get:function(){var e=function(e){e?r?a():f():r?f():a()};i=t.listen(n).onValue(e),e(t.get(n))},bind:function(){this.get()},unbind:function(){i()}}},unless:function(e,t,n){return this.show(e,t,n,!0)},show:function(e,t,n,r){var i;return{deferred:!0,get:function(){var s=function(t){t?e[r?"hide":"show"]():e[r?"show":"hide"]()};i=t.listen(n).onValue(s),s(t.get(n))},bind:function(){this.get()},unbind:function(){i()}}},hide:function(e,t,n){return this.show(e,t,n,!0)},css:function(e,t,n){var s=n.split(/\s+(?:&&|and)\s+/gi),o=[];return{set:function(){r.each(s,function(n){var r=n.split(/\s+as\s+/gi);o.push(t.listen(r[0]).startWith(t.get(r[0])).assign(e,"css",r[1]))})},bind:function(){this.set()},unbind:function(){i(o)}}},text:function(e,t,n){var r;return{set:function(){r=t.listen(n).startWith(t.get(n)).onValue(e,"text")},bind:function(){this.set()},unbind:function(){r()}}},value:function(e,t,n){var r=[],s=e.asEventStream("input change copy paste keyup");return{get:function(){r.push(s.map(function(){return e.val()}).assign(t,"set",n))},set:function(){r.push(t.listen(n).startWith(t.get(n)).assign(e,"val"))},bind:function(){this.set(),this.get()},unbind:function(){i(r)}}}},e}({}),u=function(s){var u=n,a=r,f=i,l=function(t){return this.__initialValues=t,this.__currentStateIndex=0,u.extend(this,f),u.extend(this,a.data),this.state=[],this.changes=new e.Bus,this.events=new e.Bus,this.isNew=!0,u.isUndefined(t)||this.set(t),this};return l.prototype={constructor:l,_changeToState:function(e,t){return this.state[e]&&(this.__currentStateIndex=e,this.update(this.state[e].attributes,t)),this},toString:function(){return JSON.stringify(this.toJSON())},toJSON:function(){return this.get()},get:function(e){var t=this.state[this.__currentStateIndex],n;return u.isUndefined(t)?n=undefined:u.isString(e)?n=u.getObjectValueByPath(t.attributes,e):u.isObject(t.attributes)||u.isArray(t.attributes)?n=t.attributes:n=t.attributes,u.clone(n)},parse:function(e){return e},validate:function(e){return!0},changedAttributes:function(){return this.maxStatesLength>2&&this.__currentStateIndex?u.difference(this.state[this.__currentStateIndex-1].attributes,this.get()):this.get()},sync:function(n,r){var i,s,o;r=r||{};if(!this.url)throw new Error("This class instance doesn't have any url, it cannot be synched");switch(n){case"save":this.isNew?(n="create",i="POST"):(n="update",r.patch?i="PATCH":i="PUT");break;case"delete":i="DELETE";break;default:n="read",i="GET"}return i==="PATCH"?o=this.changedAttributes():i!=="GET"&&(o=this.get()),this.emulateHTTP&&o&&(o=u.extend({_method:i},o)),s=t.ajax(u.extend({url:this.url,type:this.emulateHTTP?i==="GET"?"GET":"POST":i,data:i==="GET"?null:JSON.stringify(o),dataType:"json"},r)),s.always(u.bind(function(){this.events.push("sync")},this)),s.success(u.bind(function(e){i==="GET"?this.update(e,"read"):this.events.push(n)},this)),s.fail(u.bind(this.events.error,this.events)),new e.fromPromise(s)},fetch:function(e){return this.sync("read",e)},save:function(e){return this.sync("save",e)},set:function(){var e=arguments,t=this.toJSON(),n=!1;return e.length===2&&u.isString(e[0])&&!u.isUndefined(e[1])?n=u.setObjectValueByPath(t,e[0],e[1]):(u.isObject(t)?u.extend(t,e[0]):t=e[0],n=!0),n&&this.update(t,"set"),this},unset:function(e){var t=this.get();return e?u.setObjectValueByPath(t,e,null):t=undefined,this.update(t,"unset"),this},reset:function(){return this.update(this.__initialValues,"reset"),this},add:function(e,t,n){var r=u.isString(t)?this.get(t):this.get();if(!u.isArray(r))throw new Error("You cannot push new data in an element that is not an array");return r.splice(n||r.length,0,e),t?this.set(t,r):this.update(r,"add"),this},remove:function(e,t){var n=u.isString(t)?this.get(t):this.get(),r;if(!u.isArray(n))throw new Error("You cannot remove data from an element that is not an array");r=u.indexOf(n,e);if(!~r)throw new Error(JSON.stringify(e)+" was not found in this array");return n.splice(r,1),t?this.set(t,n):this.update(n,"remove"),this},update:function(e,t){var n=this.validate(e);return n!==!0?(this.events.error(n),!1):(e=this.parse(e),u.contains(["set","unset","reset","read","add","remove"],t)&&(this.state.push({method:t,attributes:e}),this.state.length>this.maxStatesLength+1&&this.state.shift(),this.__currentStateIndex=this.state.length-1,u.isArray(e)&&(this.length=e.length)),this.changes.push(e),this.events.push(t),this.attributes=e,this)},clone:function(){return(new o.Data(this.get())).extend(this)},bind:function(e,t,n,r){var i=this,s=u.isUndefined(r)?!0:r,o=function(t){e.set.apply(e,n?[n,t]:[t])},a=function(e){i.set.apply(i,t?[t,e]:[e])};return s&&e.listen(n).onValue(a),this.listen(t).onValue(o),this},listen:function(e){var t,n;return e?(t=this.get(e),n=this.changes.map("."+e)):(t=this.get(),n=this.changes),n.startWith(t).skipWhile(function(e){return u.isEqual(e,t)}).skipDuplicates(u.isEqual)},on:function(e){return this.events.filter(function(t){return u.contains(e.split(" "),t)}).skipDuplicates()},undo:function(){return this.__currentStateIndex>0&&this._changeToState(--this.__currentStateIndex,"undo"),this},redo:function(){return this.__currentStateIndex<this.maxStatesLength&&this._changeToState(++this.__currentStateIndex,"redo"),this},destroy:function(e){var t,n=u.bind(function(){this.changes.end(),this.events.end(),this.removeProperties()},this);this.url&&!this.isNew?this.sync("delete",e).done(n):n()}},s=l,s}({}),a=function(u){var a=n,f=s,l=r,c=i,h=function(t){return this.options=t,this.destroyDataOnRemove=!1,this.events=[],this.callbacks=[],this.binders=[],this.subviews=[],a.extend(this,c),a.extend(this,l.view),a.extend(this,t||{}),this.state=new e.Bus,this.setData(this.data),this.setElement(this.el),this.state.onValue(a.bind(this.exec,this)),this};return h.prototype={constructor:h,setData:function(e){return this.data&&this.destroyDataOnRemove&&this.data instanceof o.Data&&this.data.destroy(),e&&e instanceof o.Data?this.data=e:(this.data=new o.Data(e||{}),this.destroyDatasCreated&&(this.destroyDataOnRemove=!0)),this},setElement:function(e){var n={};return e?this.$el=e instanceof a.$?this.options.el:a.$(e):this.$el=t("<"+this.tagName+">"),this.el=this.$el[0],this.className&&(n["class"]=this.className),this.id&&(n.id=this.id),this.$el.attr(n),this},$:function(e){return a.$(e,this.$el)},render:function(){return this.state.push("beforeRender"),this.template&&(a.isString(this.template)&&(this.template=this.fetchTemplate(this.template)),this.$el.html(a.isFunction(this.template)?this.template(this.data.get()):this.template)),this.bind(),a.isArray(this.views)&&this.insertSubviews(this.views),this.state.push("afterRender"),this},insertSubviews:function(e){var t=this;return a.each(e,function(e){var n=a.keys(e)[0],r=e[n];n?t.setSubview(n,r):t.insertSubview(r),r.render()}),this},insertSubview:function(e){return this.subviews.push(e),this.insert(e.$el),e},setSubview:function(e,t){var n=this.$(e);if(!n.length)throw new Error("no element found with the "+e+" selector");return this.subviews.push(t),n.append(t.$el),t},unbind:function(){var e=this;return this.$el.off(),a.each(this.events,function(t,n){this[n.name]&&(e[n.name].onValue()(),e[n.name]=null)}),a.each(this.callbacks,function(e){e()}),a.each(this.subviews,function(e){e.unbind()}),a.each(this.binders,function(e){e()}),this.binders=[],this},on:function(e){return this.state.filter(function(t){return a.contains(e.split(" "),t)}).skipDuplicates()},bindingPath:"",placeholderPath:"",bind:function(){var e=this,n=[],r=function(t,r,i){var s=t.attr(r),o;if(!s)return;e.placeholderPath&&e.bindingPath&&(s=s.replace(e.placeholderPath,e.bindingPath)),s=s.replace(/[\n\r]+/g,"").replace(/^\s\s*/,"").replace(/\s\s*$/,""),o=f[i](t,e.data,s),o.deferred?n.push(o):o.bind(),e.binders.push(o.unbind)};return this.unbind(),a.each(this.subviews,function(e){e.bind()}),a.each(f,function(n){var i=e.binderSelector+n;e.$("["+i+"]").each(function(e,s){r(t(s),i,n)}),r(e.$el,i,n)}),a.each(n,function(e){e.bind()}),a.each(this.events,function(t,n){if(!t.name)throw new Error("You must specify an event name for each event assigned to this view");e[t.name]=e.$el.asEventStream(t.type,t.el),e.methods[t.name]&&a.isFunction(e.methods[t.name])&&e.callbacks.push(e[t.name].onValue(a.bind(e.methods[t.name],e)))}),this},remove:function(){this.state.push("beforeRemove"),this.state.end(),this.unbind(),this.destroyDataOnRemove&&this.data.destroy(),a.each(this.subviews,function(e){e.remove()}),this.$el&&this.$el.remove(),this.removeProperties()}},u=h,u}({}),o=function(e){return e={helpers:n,defaults:r,mixins:i,binders:s,Data:u,View:a,create:{View:function(e){return new o.View(e)},Data:function(e){return new o.Data(e)}}},e}({}),o});