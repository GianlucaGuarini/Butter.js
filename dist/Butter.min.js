(function(e,t){typeof define=="function"&&define.amd?define(["baconjs","jquery"],function(n,r){return e.Butter=t(n,r)}):typeof exports=="object"?module.exports=t(require("baconjs"),require("jquery")):e.Butter=t(Bacon,jQuery)})(this,function(e,t){var n,r,i,s,o,u,a,f,l,c;return n=c=function(n){var r=Object.prototype.toString,i=Object.keys,s=Array.prototype.indexOf,o=Array.prototype.forEach,u=function(e,t){var n,r=0,i;t=t.replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),n=t&&t.length;while(r<n-1){i=t[r];if(!e[i])return;e=e[i],r++}return{pathArray:t,lastKey:t[t.length-1],value:e}},a={$:t,isBoolean:function(e){return typeof e=="boolean"},isObject:function(e){return r.call(e)==="[object Object]"&&!a.isUndefined(e)&&e!==null},isString:function(e){return typeof e=="string"},isArray:function(e){return r.call(e)==="[object Array]"},isRegExp:function(e){return r.call(e)==="[object RegExp]"},isFunction:function(e){return r.call(e)==="[object Function]"},isUndefined:function(e){return typeof e=="undefined"},isEqual:function(e,t){return JSON.stringify(e)===JSON.stringify(t)},isEmpty:function(e){return a.isObject(e)?JSON.stringify(e).length===2:e.length===0},extend:function(e,t){for(var n in t)e[n]=t[n];return e},difference:function(e,t,n){var r=this,i=!1;return a.isEqual(e,t)||(i=e,a.isArray(e)?(i=[],a.each(e,function(e){r.contains(t,e)||i.push(e)})):a.isObject(e)&&(i={},a.each(e,function(e,n){t[e]||(i[e]=n)}))),i},clone:function(e){return a.isArray(e)||a.isObject(e)?JSON.parse(JSON.stringify(e)):e},contains:function(e,t){return!!~a.indexOf(e,t)},indexOf:function(t,n){var r=-1,i=0,o=t.length;if(a.isObject(n)){for(;i<o;i++)if(a.isEqual(t[i],n)){r=i;break}return r}return s?s.call(t,n):e._.indexOf(t,n)},each:function(e,n,r){var s=this,u=a.isObject(e);r=r||n.prototype;if(!e)return;o&&i?u?o.call(i(e),function(t){n.apply(r,[t,e[t]])}):o.call(e,a.bind(n,r)):t.each(e,function(e,t){n.apply(r,u?[e,t]:[t,e])})},keys:i||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},bind:function(e,t){return function(){return e.apply(t,arguments)}},getObjectValueByPath:function(e,t){var n=u(e,t);if(!n||!n.value)return;return n.value[n.lastKey]},setObjectValueByPath:function(e,t,n){var r=u(e,t);if(!r||!r.value)return;return n===null?(r.value[r.lastKey]=null,delete r.value[r.lastKey],!0):(r.value[r.lastKey]=n,r.value)}};return n=a,n}({}),r=function(e){return e={view:{binderSelector:"data-",destroyDatasCreated:!0,tagName:"div",id:null,className:null,fetchTemplate:function(e){return t(e).html()},insert:function(e){this.$el.append(e)}},data:{maxStatesLength:10,emulateHTTP:!0},router:{}},e}({}),i=function(e){var t=n;return e={extend:function(e){return t.extend(this,e),this},exec:function(e){typeof this[e]=="function"&&this[e].apply(this,arguments)},removeProperties:function(){t.each(this,function(e,t){this[t]=null,delete this[t]},this)}},e}({}),s=function(e){var r=n,i=function(e){r.each(e,function(e){e()})},s=function(){return t('<script type="text/bacon-marker"></script>')};return e={each:function(e,t,n){e.removeAttr(u.defaults.view.binderSelector+"each");var i=n.split(/\s+as\s+/gi),s=[],o=i[0],a=i[1],f=e.parent(),l=function(e,n){var r=c.clone(),i;return i=new u.View({el:r,data:t,placeholderPath:a,bindingPath:o+"."+n}),s.push(i),i.bind(),i},c=e.clone().removeAttr(u.defaults.view.binderSelector+"each");return e.remove(),{deferred:!0,set:function(){var e=[];r.each(t.get(o),function(){e.push(l.apply(this,arguments).$el)},this),f.append(e),e=null,t.listen(o).debounce(50).onValue(r.bind(function(t){var n=s.length-t.length;if(!n)return;if(n>0)while(n--)s[s.length-1].remove(),s.splice(s.length-1,1);else{e=[];while(n++<0){var r=t.length+n-1;e.push(l(t[r],r).$el)}f.append(e)}},this))},bind:function(){this.set()},unbind:function(){r.each(s,function(e){e.remove()}),s=null,e.attr(u.defaults.view.binderSelector+"each",n),f.append(e)}}},"if":function(e,t,n,r){var i,o=!1,u=s(),a=function(){o||(o=!0,e.replaceWith(u))},f=function(){o&&(o=!1,u.replaceWith(e))};return{deferred:!0,get:function(){var e=function(e){e?r?a():f():r?f():a()};i=t.listen(n).debounce(50).onValue(e),e(t.get(n))},bind:function(){this.get()},unbind:function(){i()}}},unless:function(e,t,n){return this.show(e,t,n,!0)},show:function(e,t,n,r){var i;return{deferred:!0,get:function(){var s=function(t){t?e[r?"hide":"show"]():e[r?"show":"hide"]()};i=t.listen(n).debounce(50).onValue(s),s(t.get(n))},bind:function(){this.get()},unbind:function(){i()}}},hide:function(e,t,n){return this.show(e,t,n,!0)},css:function(e,t,n){var s=n.split(/\s+(?:&&|and)\s+/gi),o=[];return{set:function(){r.each(s,function(n){var r=n.split(/\s+as\s+/gi);o.push(t.listen(r[0]).startWith(t.get(r[0])).assign(e,"css",r[1]))})},bind:function(){this.set()},unbind:function(){i(o)}}},text:function(e,t,n){var r;return{set:function(){r=t.listen(n).debounce(50).startWith(t.get(n)).onValue(e,"text")},bind:function(){this.set()},unbind:function(){r()}}},value:function(e,t,n){var r=[],s=e.asEventStream("input change copy paste keyup");return{get:function(){r.push(s.map(function(){return e.val()}).debounce(50).assign(t,"set",n))},set:function(){r.push(t.listen(n).startWith(t.get(n)).assign(e,"val"))},bind:function(){this.set(),this.get()},unbind:function(){i(r)}}}},e}({}),o=function(e){function n(e){return e.replace(/([=!:$\/()])/g,"\\$1")}function i(e,s,o){s&&!Array.isArray(s)&&(o=s,s=null),s=s||[],o=o||{};var u=o.strict,a=o.end!==!1,f=o.sensitive?"":"i",l=0;if(e instanceof RegExp){var c=e.source.match(/\((?!\?)/g)||[];return s.push.apply(s,c.map(function(e,t){return{name:t,delimiter:null,optional:!1,repeat:!1}})),r(e,s)}if(Array.isArray(e))return e=e.map(function(e){return i(e,s,o).source}),r(new RegExp("(?:"+e.join("|")+")",f),s);e=e.replace(t,function(e,t,r,i,o,u,a,f){if(t)return t;if(f)return"\\"+f;var c=a==="+"||a==="*",h=a==="?"||a==="*";return s.push({name:i||l++,delimiter:r||"/",optional:h,repeat:c}),r=r?"\\"+r:"",o=n(o||u||"[^"+(r||"\\/")+"]+?"),c&&(o=o+"(?:"+r+o+")*"),h?"(?:"+r+"("+o+"))?":r+"("+o+")"});var h=e[e.length-1]==="/";return u||(e=(h?e.slice(0,-2):e)+"(?:\\/(?=$))?"),a||(e+=u&&h?"":"(?=\\/|$)"),r(new RegExp("^"+e+(a?"$":""),f),s)}function c(e,t){if("function"==typeof e)return c("*",e);if("function"==typeof t){var n=new v(e);for(var r=1;r<arguments.length;++r)c.callbacks.push(n.middleware(arguments[r]))}else"string"==typeof e?c["string"==typeof t?"redirect":"show"](e,t):c.start(e)}function h(e){if(e.handled)return;var t;f?t=u+s.hash.replace("#!",""):t=s.pathname+s.search;if(t===e.canonicalPath)return;c.stop(),e.handled=!1,s.href=e.canonicalPath}function p(e){return decodeURIComponent(e.replace(/\+/g," "))}function d(e,t){e=p(e),"/"===e[0]&&0!==e.indexOf(u)&&(e=u+(f?"#!":"")+e);var n=e.indexOf("?");this.canonicalPath=e,this.path=e.replace(u,"")||"/",f&&(this.path=this.path.replace("#!","")||"/"),this.title=document.title,this.state=t||{},this.state.path=e,this.querystring=~n?e.slice(n+1):"",this.pathname=~n?e.slice(0,n):e,this.params=[],this.hash="";if(!f){if(!~this.path.indexOf("#"))return;var r=this.path.split("#");this.path=r[0],this.hash=r[1]||"",this.querystring=this.querystring.split("#")[0]}}function v(e,t){t=t||{},this.path=e==="*"?"(.*)":e,this.method="GET",this.regexp=i(this.path,this.keys=[],t.sensitive,t.strict)}function m(e){if(e.state){var t=e.state.path;c.replace(t,e.state)}else c.show(s.pathname+s.hash)}function g(e){if(1!==y(e))return;if(e.metaKey||e.ctrlKey||e.shiftKey)return;if(e.defaultPrevented)return;var t=e.target;while(t&&"A"!==t.nodeName)t=t.parentNode;if(!t||"A"!==t.nodeName)return;if(t.getAttribute("download"))return;var n=t.getAttribute("href");if(!f&&t.pathname===s.pathname&&(t.hash||"#"===n))return;if(n&&n.indexOf("mailto:")>-1)return;if(t.target)return;if(!b(t.href))return;var r=t.pathname+t.search+(t.hash||""),i=r;r=r.replace(u,""),f&&(r=r.replace("#!",""));if(u&&i===r)return;e.preventDefault(),c.show(i)}function y(e){return e=e||window.event,null===e.which?e.button:e.which}function b(e){var t=s.protocol+"//"+s.hostname;return s.port&&(t+=":"+s.port),e&&0===e.indexOf(t)}var t=new RegExp(["(\\\\.)","([\\/.])?(?:\\:(\\w+)(?:\\(((?:\\\\.|[^)])*)\\))?|\\(((?:\\\\.|[^)])*)\\))([+*?])?","([.+*?=^!:${}()[\\]|\\/])"].join("|"),"g"),r=function(e,t){return e.keys=t,e},s=window.history.location||window.location,o=!0,u="",a,f=!1,l;return c.callbacks=[],c.exits=[],c.current="",c.base=function(e){if(0===arguments.length)return u;u=e},c.start=function(e){e=e||{};if(a)return;a=!0,!1===e.dispatch&&(o=!1),!1!==e.popstate&&window.addEventListener("popstate",m,!1),!1!==e.click&&window.addEventListener("click",g,!1),!0===e.hashbang&&(f=!0);if(!o)return;var t=f&&~s.hash.indexOf("#!")?s.hash.substr(2)+s.search:s.pathname+s.search+s.hash;c.replace(t,null,!0,o)},c.stop=function(){c.current="";if(!a)return;a=!1,window.removeEventListener("click",g,!1),window.removeEventListener("popstate",m,!1)},c.show=function(e,t,n){c.current=e;var r=new d(e,t);return!1!==n&&c.dispatch(r),!1!==r.handled&&r.pushState(),r},c.redirect=function(e,t){"string"==typeof e&&"string"==typeof t&&c(e,function(e){setTimeout(function(){c.replace(t)},0)}),"string"==typeof e&&"undefined"==typeof t&&setTimeout(function(){c.replace(e)},0)},c.replace=function(e,t,n,r){c.current=e;var i=new d(e,t);return i.init=n,i.save(),!1!==r&&c.dispatch(i),i},c.dispatch=function(e){function i(){var e=c.exits[r++];if(!e)return s();e(t,i)}function s(){var t=c.callbacks[n++];if(e.path!==c.current){e.handled=!1;return}if(!t)return h(e);t(e,s)}var t=l,n=0,r=0;l=e,t?i():s()},c.exit=function(e,t){if(typeof e=="function")return c.exit("*",e);var n=new v(e);for(var r=1;r<arguments.length;++r)c.exits.push(n.middleware(arguments[r]))},c.reset=function(){this.callbacks=[],this.exits=[]},c.Context=d,d.prototype.pushState=function(){history.pushState(this.state,this.title,f&&this.path!=="/"?"#!"+this.path:this.canonicalPath)},d.prototype.save=function(){history.replaceState(this.state,this.title,f&&this.path!=="/"?"#!"+this.path:this.canonicalPath)},c.Route=v,v.prototype.middleware=function(e){var t=this;return function(n,r){if(t.match(n.path,n.params))return e(n,r);r()}},v.prototype.match=function(e,t){var n=this.keys,r=e.indexOf("?"),i=~r?e.slice(0,r):e,s=this.regexp.exec(decodeURIComponent(i));if(!s)return!1;for(var o=1,u=s.length;o<u;++o){var a=n[o-1],f="string"==typeof s[o]?decodeURIComponent(s[o]):s[o];a?t[a.name]=undefined!==t[a.name]?t[a.name]:f:t.push(f)}return!0},c.sameOrigin=b,e=c,e}({}),a=function(s){var o=n,a=r,f=i,l=function(t){return this.__initialValues=t,this.__currentStateIndex=0,o.extend(this,f),o.extend(this,a.data),this.state=[],this.changes=new e.Bus,this.events=new e.Bus,this.isNew=!0,o.isUndefined(t)||this.set(t),this};return l.prototype={constructor:l,_changeToState:function(e,t){return this.state[e]&&(this.__currentStateIndex=e,this.update(this.state[e].attributes,t)),this},toString:function(){return JSON.stringify(this.toJSON())},toJSON:function(){return this.get()},get:function(e){var t=this.state[this.__currentStateIndex],n;return o.isUndefined(t)?n=undefined:o.isString(e)?n=o.getObjectValueByPath(t.attributes,e):o.isObject(t.attributes)||o.isArray(t.attributes)?n=t.attributes:n=t.attributes,o.clone(n)},parse:function(e){return e},validate:function(e){return!0},changedAttributes:function(){return this.maxStatesLength>2&&this.__currentStateIndex?o.difference(this.state[this.__currentStateIndex-1].attributes,this.get()):this.get()},sync:function(n,r){var i,s,u;r=r||{};if(!this.url)throw new Error("This class instance doesn't have any url, it cannot be synched");switch(n){case"save":this.isNew?(n="create",i="POST"):(n="update",r.patch?i="PATCH":i="PUT");break;case"delete":i="DELETE";break;default:n="read",i="GET"}return i==="PATCH"?u=this.changedAttributes():i!=="GET"&&(u=this.get()),this.emulateHTTP&&u&&(u=o.extend({_method:i},u)),s=t.ajax(o.extend({url:this.url,type:this.emulateHTTP?i==="GET"?"GET":"POST":i,data:i==="GET"?null:JSON.stringify(u),dataType:"json"},r)),s.always(o.bind(function(){this.events.push("sync")},this)),s.success(o.bind(function(e){i==="GET"?this.update(e,"read"):this.events.push(n)},this)),s.fail(o.bind(this.events.error,this.events)),new e.fromPromise(s)},fetch:function(e){return this.sync("read",e)},save:function(e){return this.sync("save",e)},set:function(){var e=arguments,t=this.toJSON(),n=!1;return e.length===2&&o.isString(e[0])&&!o.isUndefined(e[1])?n=o.setObjectValueByPath(t,e[0],e[1]):(o.isObject(t)?o.extend(t,e[0]):t=e[0],n=!0),n&&this.update(t,"set"),this},unset:function(e){var t=this.get();return e?o.setObjectValueByPath(t,e,null):t=undefined,this.update(t,"unset"),this},reset:function(){return this.update(this.__initialValues,"reset"),this},add:function(e,t,n){var r=o.isString(t)?this.get(t):this.get();if(!o.isArray(r))throw new Error("You cannot push new data in an element that is not an array");return r.splice(n||r.length,0,e),t?this.set(t,r):this.update(r,"add"),this},remove:function(e,t){var n=o.isString(t)?this.get(t):this.get(),r;if(!o.isArray(n))throw new Error("You cannot remove data from an element that is not an array");r=o.indexOf(n,e);if(!~r)throw new Error(JSON.stringify(e)+" was not found in this array");return n.splice(r,1),t?this.set(t,n):this.update(n,"remove"),this},update:function(e,t){var n=this.validate(e);return n!==!0?(this.events.error(n),!1):(e=this.parse(e),o.contains(["set","unset","reset","read","add","remove"],t)&&(this.state.push({method:t,attributes:e}),this.state.length>this.maxStatesLength+1&&this.state.shift(),this.__currentStateIndex=this.state.length-1,o.isArray(e)&&(this.length=e.length)),this.changes.push(e),this.events.push(t),this.attributes=e,this)},clone:function(){return(new u.Data(this.get())).extend(this)},bind:function(e,t,n,r){var i=this,s=o.isUndefined(r)?!0:r;return s&&e.listen(n).onValue(function(e){i.set.apply(i,t?[t,e]:[e])}),this.listen(t).onValue(function(t){e.set.apply(e,n?[n,t]:[t])}),this},listen:function(e){var t,n;return e?(t=this.get(e),n=this.changes.map("."+e)):(t=this.get(),n=this.changes),n.startWith(t).skipWhile(function(e){return o.isEqual(e,t)}).skipDuplicates(o.isEqual)},on:function(e){return this.events.filter(function(t){return o.contains(e.split(" "),t)}).skipDuplicates()},undo:function(){return this.__currentStateIndex>0&&this._changeToState(--this.__currentStateIndex,"undo"),this},redo:function(){return this.__currentStateIndex<this.maxStatesLength&&this._changeToState(++this.__currentStateIndex,"redo"),this},destroy:function(e){var t,n=o.bind(function(){this.changes.end(),this.events.end(),this.removeProperties()},this);this.url&&!this.isNew?this.sync("delete",e).done(n):n()}},s=l,s}({}),f=function(o){var a=n,f=s,l=r,c=i,h=function(t){return this.options=t,this.destroyDataOnRemove=!1,this.events=[],this.callbacks=[],this.binders=[],this.subviews=[],a.extend(this,c),a.extend(this,l.view),a.extend(this,t||{}),this.state=new e.Bus,this.setData(this.data),this.setElement(this.el),this.state.onValue(a.bind(this.exec,this)),this};return h.prototype={constructor:h,setData:function(e){return this.data&&this.destroyDataOnRemove&&this.data instanceof u.Data&&this.data.destroy(),e&&e instanceof u.Data?this.data=e:(this.data=new u.Data(e||{}),this.destroyDatasCreated&&(this.destroyDataOnRemove=!0)),this},setElement:function(e){var n={};return e?this.$el=e instanceof a.$?this.options.el:a.$(e):this.$el=t("<"+this.tagName+">"),this.el=this.$el[0],this.className&&(n["class"]=this.className),this.id&&(n.id=this.id),this.$el.attr(n),this},$:function(e){return a.$(e,this.$el)},render:function(){return this.state.push("beforeRender"),this.template&&(a.isString(this.template)&&(this.template=this.fetchTemplate(this.template)),this.$el.html(a.isFunction(this.template)?this.template(this.data.get()):this.template)),this.bind(),a.isArray(this.views)&&this.insertSubviews(this.views),this.state.push("afterRender"),this},insertSubviews:function(e){return a.each(e,function(e){var t=a.keys(e)[0],n=e[t];t?this.setSubview(t,n):this.insertSubview(n),n.render()},this),this},insertSubview:function(e){return this.subviews.push(e),this.insert(e.$el),e},setSubview:function(e,t){var n=this.$(e);if(!n.length)throw new Error("no element found with the "+e+" selector");return this.subviews.push(t),n.append(t.$el),t},unbind:function(){return this.$el.off(),a.each(this.events,function(e,t){this[t.name]&&(this[t.name].onValue()(),this[t.name]=null)},this),a.each(this.callbacks,function(e){e()}),a.each(this.subviews,function(e){e.unbind()}),a.each(this.binders,function(e){e()},this),this.binders=[],this},on:function(e){return this.state.filter(function(t){return a.contains(e.split(" "),t)}).skipDuplicates()},bindingPath:"",placeholderPath:"",bind:function(){var e=this,n=[],r=function(t,r,i){var s=t.attr(r),o;if(!s)return;e.placeholderPath&&e.bindingPath&&(s=s.replace(e.placeholderPath,e.bindingPath)),s=s.replace(/[\n\r]+/g,"").replace(/^\s\s*/,"").replace(/\s\s*$/,""),o=f[i](t,e.data,s),o.deferred?n.push(o):o.bind(),e.binders.push(o.unbind)};return this.unbind(),a.each(this.subviews,function(e){e.bind()}),a.each(f,function(e){var n=this.binderSelector+e;this.$("["+n+"]").each(function(){r(t(this),n,e)}),r(this.$el,n,e)},this),a.each(n,function(e){e.bind()}),a.each(this.events,function(e,t){if(!e.name)throw new Error("You must specify an event name for each event assigned to this view");this[e.name]=this.$el.asEventStream(e.type,e.el),this.methods[e.name]&&a.isFunction(this.methods[e.name])&&this.callbacks.push(this[e.name].onValue(a.bind(this.methods[e.name],this)))},this),this},remove:function(){this.state.push("beforeRemove"),this.state.end(),this.unbind(),this.destroyDataOnRemove&&this.data.destroy(),a.each(this.subviews,function(e){e.remove()},this),this.$el&&this.$el.remove(),this.removeProperties()}},o=h,o}({}),l=function(t){var u=n,a=s,f=r,l=i,c=o.exports,h=function(e){return u.extend(this,l),console.log(c),c(e),this};return h.prototype={constructor:h,_routes:[],history:c,map:function(t){var n=new e.Bus;return c(t,function(e){n.push(e)}),this._routes.push(t),n},reset:function(){},removeRoute:function(e){}},t=h,t}({}),u=function(e){return e={helpers:n,defaults:r,mixins:i,binders:s,history:o,Data:a,View:f,Router:l,create:{View:function(e){return new u.View(e)},Data:function(e){return new u.Data(e)}}},e}({}),u});